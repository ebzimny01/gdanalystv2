{% extends "gdanalyst/layout.html" %}
{% load static %}

{% block title %}
    GD Analyst
{% endblock %}

{% block body %}
    <div class="h3" id="gameresultsjobid"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
{% if job_id %}
    <script>
        var jobUrl = "{% url 'jobstatus' jobid=job_id %}";
        var dots = 1;
        var progressTitle = document.getElementById('gameresultsjobid');
        var progressText = 'Requesting game results '
        updateProgressTitle(progressText);
        var timer = setInterval(function() {
            updateProgressTitle(progressText);
            axios.get(jobUrl)
                .then(function(response){
                    var jobStatus = response.data
                    if (jobStatus === 'finished') {
                        clearTimer('Finished loading game results.');
                        window.location.replace("{% url 'display_game_results' jobid=job_id %}");
                    } else if (jobStatus === 'failed') {
                    clearTimer('An error occurred');
                    } else if (jobStatus === 'queued') {
                        progressText = 'Your request for game results has been queued ';
                    } else if (jobStatus === 'started') {
                        progressText = 'Starting to process game results ';
                    }
                })
                .catch(function(err){
                    console.log('err', err);
                    clearTimer('An error occurred');
                });
            }, 800);

        function updateProgressTitle(message) {
            dots++;
            if (dots > 3) {
            dots = 1;
            }
            progressTitle.innerHTML = message;
            for (var i = 0; i < dots; i++) {
            progressTitle.innerHTML += '.';
            }
        }
        function clearTimer(message) {
            clearInterval(timer);
            progressTitle.innerHTML = message;
        }
    </script>
{% endif %}
{% endblock %}
